<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layuiAdmin 网站用户</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="__STATIC__/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="__STATIC__/layuiadmin/style/admin.css" media="all">
    <style>
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none !important;
            margin: 0;
        }
    </style>
</head>
<body>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <div style="padding-bottom: 10px;">
                <button class="layui-btn" id="table-menu-add">添加</button>
            </div>

            <table class="layui-table layui-form" id="tree-table" lay-filter="tree-table"></table>

            <div id="page"></div>
        </div>
    </div>
</div>

<script src="__STATIC__/layuiadmin/layui/layui.js"></script>
<script>
    layui.config({
        base: '__STATIC__/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index', //主入口模块
        treeTable: '{/}__STATIC__/layuiadmin/lib/extend/treeTable'
    }).use(['index', 'table', 'treeTable', 'laypage'], function () {
        var $ = layui.$
            , form = layui.form
            , treeTable = layui.treeTable,
            laypage = layui.laypage;

        // 当前所在页
        var page = 1;

        // 加载数据
        loadData(page);

        // 加载列表数据
        function loadData() {
            $.get('/admin/menu/list?page=' + page).then(res => {
                if (res.code === 0) {
                    // 渲染分页
                    laypage.render({
                        elem: 'page' //注意，这里的 test1 是 ID，不用加 # 号
                        , count: res.data.total //数据总数，从服务端得到
                        , limit: res.data.per_page
                        , curr: page,
                        jump: function (obj, first) {
                            if (!first) {
                                page = obj.curr;
                                loadData(obj.curr);
                            }
                        }
                    });

                    // 渲染数据
                    treeTable.render({
                        elem: '#tree-table',
                        data: res.data.data,
                        icon_key: 'name',
                        hide_class: 'layui-hide',
                        end: function (e) {
                            form.render();
                        },
                        cols: [
                            // {key: 'id', title: '编号'},
                            {key: 'name', title: '名称'},
                            {
                                key: 'icon', align: 'center', title: '图标', template: function (item) {
                                    if (item.icon){
                                        return '<i class="layui-icon ' + item.icon + '"></i>';
                                    }
                                }
                            },
                            {key: 'path', align: 'center', title: '路径'},
                            {
                                key: 'sort', title: '排序', align: 'center', width: '50px', template: function (item) {
                                    return '<input class="layui-input menu-sort" data-id="' + item.id + '" autocomplete="off" type="number" min="0" max="254" name="edit" value="' + item.sort + '" lay-filter="sort"/>';
                                }
                            },
                            {
                                title: '状态', width: '100px', align: 'center',
                                template: function (item) {
                                    if (item.status === 1) {
                                        return '<input type="checkbox" lay-filter="status" data-id="' + item.id + '" name="status" lay-skin="switch" lay-text="ON|OFF" checked>';
                                    } else {
                                        return '<input type="checkbox" lay-filter="status" data-id="' + item.id + '" name="status" lay-skin="switch" lay-text="ON|OFF">';
                                    }
                                }
                            },
                            {key: 'update_time', align: 'center', title: '更新时间', width: '150px'},
                            {
                                title: '操作', align: 'center', width: '150px',
                                template: function (item) {
                                    return `<a class="layui-btn layui-btn-normal layui-btn-xs"  lay-filter="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
                                    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-filter="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
                                   `;
                                }
                            }
                        ]
                    });
                }
            })
        }

        // 添加菜单
        $('#table-menu-add').on('click', function () {
            layer.open({
                type: 2
                , title: '添加菜单'
                , content: 'menuform.html'
                , area: ['500px', '500px']
                , btn: ['确定', '取消']
                , yes: function (index, layero) {
                    var iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'LAY-menu-front-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                    //监听提交
                    iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                        var field = data.field; //获取提交的字段
                        console.log(field)
                        $.ajax({
                            url: '/admin/menu/save',
                            type: 'post',
                            data: field,
                            success: function (res) {
                                if (res.code === 0) {
                                    loadData(page);
                                }
                                layer.msg(res.msg);
                            }
                        })
                        layer.close(index); //关闭弹层
                    });
                    submit.trigger('click');
                }
            });
        });

        // 编辑
        treeTable.on('tree(edit)', function (data) {
            var id = data.item.id;
            layer.open({
                type: 2
                , title: '编辑菜单'
                , content: 'menuform.html?id=' + id
                , area: ['500px', '500px']
                , btn: ['确定', '取消']
                , yes: function (index, layero) {
                    var iframeWindow = window['layui-layer-iframe' + index]
                        , submitID = 'LAY-menu-front-submit'
                        , submit = layero.find('iframe').contents().find('#' + submitID);

                    //监听提交
                    iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                        var field = data.field; //获取提交的字段
                        menuUpdate(id, field);
                        layer.close(index); //关闭弹层
                    });
                    submit.trigger('click');
                }
            });
        });

        // 删除
        treeTable.on('tree(del)', function (data) {
            layer.confirm('确定删除吗？', {icon: 2, title: '警告'}, function (index) {
                $.ajax({
                    url: '/admin/menu/' + data.item.id,
                    type: 'delete',
                    success: function (res) {
                        if (res.code === 0) {
                            loadData(page); // 重新加载数据
                            layer.close(index); //关闭弹层
                        }
                        layer.msg(res.msg);
                    }
                })
            });
        });

        // 排序修改
        $('#tree-table').on('change', '.menu-sort', function (data) {
            var id = data['currentTarget'].dataset.id;
            var sort = data['currentTarget'].value;
            menuUpdate(id, {sort});
        })

        // 修改菜单状态
        form.on('switch(status)', function (data) {
            var id = data.elem['dataset'].id;
            var status = data.elem.checked ? 1 : 0;
            menuUpdate(id, {status});
        });

        // 更新数据
        function menuUpdate(id, data) {
            $.ajax({
                url: '/admin/menu/' + id,
                type: 'put',
                data,
                success: function (res) {
                    if (res.code === 0) {
                        loadData(page); // 重新加载数据
                    }
                    layer.msg(res.msg);
                }
            })
        }

    });
</script>
</body>
</html>
